<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Portfolio</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <a href="index.html" class="block hover:text-cyan-400"></a>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">


</head>

<body class="bg-gray-900 text-white font-sans">
  <div class="flex h-screen">
    <!-- Sidebar -->
    <aside class="w-64 bg-gray-800 p-6 flex flex-col">
      <h2 class="text-2xl font-semibold text-white mb-8 mt-2">Portfolio Manager</h2>
      <nav class="space-y-8 flex-1">
        <a href="index.html" class="flex items-center text-white hover:text-cyan-400">
          <span class="material-icons mr-2">dashboard</span>
          <span>Dashboard</span>
        </a>

        <a href="portfolio.html" class="flex items-center text-cyan-400 font-semibold">
          <span class="material-icons mr-2">pie_chart</span>
          <span>Portfolio</span>
        </a>

        <a href="news.html" class="flex items-center hover:text-cyan-400">
          <span class="material-icons mr-2">trending_up</span>
          <span>News</span>
        </a>

        <a href="analysis.html" class="flex items-center hover:text-cyan-400">
          <span class="material-icons mr-2">computer</span>
          <span>AI Analysis</span>
        </a>

      </nav>
      <div class="space-y-8">
        <a href="support.html" class="flex items-center hover:text-cyan-400">
          <span class="material-icons mr-2">help_outline</span>
          <span>Support</span>
        </a>

        <a href="settings.html" class="flex items-center hover:text-cyan-400">
          <span class="material-icons mr-2">settings</span>
          <span>Settings</span>
        </a>
        <div class="flex items-center space-x-3 mt-4">
          <img src="https://ui-avatars.com/api/?name=Kanash&background=4f46e5&color=fff&rounded=true" alt="Avatar"
            class="w-8 h-8 rounded-full" />
          <a href="login.html" class="text-sm text-white font-medium">Kanash</a>
        </div>
      </div>
    </aside>

    <!-- Pop Up Windows-->



    <main class="flex-1 p-8 space-y-6">
      <div>
        <h1 class="text-2xl font-semibold">Hello, Kanash</h1>
        <p class="text-gray-400 text-sm">View, buy, and sell your stocks here!</p>
      </div>

      <div class="grid grid-cols-4 gap-4">
        <div class="bg-gray-800 p-4 rounded-lg col-span-1">
          <p class="text-sm text-gray-400">Total Stock Value</p>
          <p class="text-2xl font-semibold text-white" id="totalStockValue">$0.00</p>
        </div>
        <div class="bg-gray-800 p-4 rounded-lg col-span-1">
          <p class="text-sm text-gray-400">Total Buying Power</p>
          <p class="text-2xl font-semibold text-white" id="buyingPower">$0.00</p>
        </div>
        <div class="bg-gray-800 p-4 rounded-lg col-span-1">
          <p class="text-sm text-gray-400">Total gain $</p>
          <p class="text-2xl font-semibold" id="totalGainCash">+0.00</p>
        </div>
        <div class="bg-gray-800 p-4 rounded-lg col-span-1">
          <p class="text-sm text-gray-400">Total gain %</p>
          <p class="text-2xl font-semibold" id="totalGainPercent">+0.00</p>
        </div>
        <div class="flex justify-center items-center space-x-4 mt-4">
          <button id="buyBtn" class="flex-1 bg-green-500 text-white py-2 rounded">Buy</button>
          <button id="sellBtn" class="flex-1 bg-red-500 text-white py-2 rounded">Sell</button>
        </div>
      </div>

      <!-- Table -->
      <div class="bg-gray-800 p-4 rounded-lg overflow-x-auto">
        <div class="scrollable overflow-y-auto max-h-[400px]">
          <table class="w-full text-sm">
            <thead class="text-center text-cyan-100 text-[14px] sticky top-0 bg-gray-800 z-10">
              <tr>
                <th class="p-4">Symbol</th>
                <th class="p-4">Short Name</th>
                <th class="p-4">Last Price</th>
                <th class="p-4">Market Value</th>
                <th class="p-4">Quantity</th>
                <th class="p-4">Market Cap</th>
                <th class="p-4">Volume</th>
                <th class="p-4">Total gain $</th>
                <th class="p-4">Total gain %</th>
                <th class="p-4">Avg Purchase price</th>
              </tr>
            </thead>
            <tbody>
              <!-- Your JS script will populate this -->
            </tbody>
          </table>
        </div>
      </div>

    </main>
  </div>
  <div id="buyModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-gray-900 p-6 rounded-xl w-80 relative">
      <button onclick="closeModal('buyModal')"
        class="absolute top-4 right-4 text-white text-2xl font-bold">&times;</button>
      <h2 class="text-white text-xl font-bold mb-4 text-center">Buy Stocks</h2>
      <input type="text" placeholder="Symbol..." id="buySymbol"
        class="w-full mb-3 p-2 bg-transparent border-b border-gray-400 text-white placeholder-gray-500 focus:outline-none">
      <input type="number" placeholder="Quantity..." id="buyQuantity"
        class="w-full mb-4 p-2 bg-transparent border-b border-gray-400 text-white placeholder-gray-500 focus:outline-none">
      <button onclick="submitBuy()" class="w-full bg-green-500 text-white py-2 rounded">Buy</button>
      <p class="text-sm text-gray-400 text-right mt-4">Buying Power: <span id="buyCash">$0.00</span></p>
    </div>
  </div>
  <div id="sellModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-gray-900 p-6 rounded-xl w-80 relative">
      <button onclick="closeModal('sellModal')"
        class="absolute top-4 right-4 text-white text-2xl font-bold">&times;</button>
      <h2 class="text-white text-xl font-bold mb-4 text-center">Sell Stocks</h2>
      <input type="text" placeholder="Symbol..." id="sellSymbol"
        class="w-full mb-3 p-2 bg-transparent border-b border-gray-400 text-white placeholder-gray-500 focus:outline-none">
      <input type="number" placeholder="Quantity..." id="sellQuantity"
        class="w-full mb-4 p-2 bg-transparent border-b border-gray-400 text-white placeholder-gray-500 focus:outline-none">
      <button onclick="submitSell()" class="w-full bg-red-500 text-white py-2 rounded">Sell</button>
      <p class="text-sm text-gray-400 text-right mt-4">Buying Power: <span id="sellCash">$0.00</span></p>
    </div>
  </div>
  <script>

    const baseUrl = "https://portfolio-manager-team07.onrender.com/api";
    const localUrl = "http://localhost:8000/api";

    function openModal(id) {
      document.getElementById(id).classList.remove('hidden');
    }

    function closeModal(id) {
      document.getElementById(id).classList.add('hidden');
    }

    document.getElementById("buyBtn").addEventListener("click", () => openModal('buyModal'));
    document.getElementById("sellBtn").addEventListener("click", () => openModal('sellModal'));

    // Optional: Close when clicking outside the modal content
    window.addEventListener("click", function (e) {
      if (e.target.classList.contains("modal")) {
        closeModal('buyModal');
        closeModal('sellModal');
      }
    });

    async function loadPortfolioTable() {
      try {
        const res = await fetch(`${baseUrl}/portfolio/displayStocks`);
        const data = await res.json();
        const tableBody = document.querySelector("tbody");
        tableBody.innerHTML = "";

        let totalValue = 0;

        data.forEach(stock => {
          const numericValue = parseFloat(stock.market_value.replace(/[^0-9.-]+/g, ""));
          totalValue += numericValue;

          const row = `
          <tr class="border-t border-gray-700 text-center hover:bg-gray-700 transition-colors font-light">
            <td class="p-4">${stock.symbol}</td>
            <td class="p-4">${stock.name}</td>
            <td class="p-4">${stock.last_price}</td>
            <td class="p-4">${stock.market_value}</td>
            <td class="p-4">${stock.quantity}</td>
            <td class="p-4">${stock.market_cap}</td>
            <td class="p-4">${stock.volume}</td>
            <td class="p-4 ${stock.total_gain_amount.startsWith('-') ? 'text-red-500' : 'text-green-400'}">$${stock.total_gain_amount}</td>
            <td class="p-4 ${stock.total_gain_percent.startsWith('-') ? 'text-red-500' : 'text-green-400'}">${stock.total_gain_percent}</td>
            <td class="p-4">${stock.purchase_price}</td>
          </tr>
        `;
          tableBody.innerHTML += row;
        });

        document.getElementById("totalStockValue").innerText = `$${totalValue.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        const totalGainCashValue = data.reduce((acc, stock) => acc + parseFloat(stock.total_gain_amount.replace(/[^0-9.-]+/g, "")), 0);
        const totalGainPercentValue = data.reduce((acc, stock) => acc + parseFloat(stock.total_gain_percent.replace(/[^0-9.-]+/g, "")), 0);

        const totalGainCashElem = document.getElementById("totalGainCash");
        const totalGainPercentElem = document.getElementById("totalGainPercent");

        totalGainCashElem.innerText = `$${totalGainCashValue.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        totalGainPercentElem.innerText = `${totalGainPercentValue.toFixed(2)}%`;

        // Set color based on value
        totalGainCashElem.className = "text-2xl font-semibold " + (totalGainCashValue < 0 ? "text-red-500" : "text-green-400");
        totalGainPercentElem.className = "text-2xl font-semibold " + (totalGainPercentValue < 0 ? "text-red-500" : "text-green-400");

      } catch (err) {
        console.error("Failed to load portfolio data:", err);
      }
    }

    async function loadCashBalance() {
      try {
        const res = await fetch(`${baseUrl}/portfolio/cash`);
        const data = await res.json();
        const cash = parseFloat(data.cash_balance);

        const formatted = `$${cash.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

        document.getElementById("buyingPower").innerText = formatted;
        document.getElementById("buyCash").innerText = formatted;
        document.getElementById("sellCash").innerText = formatted;
      } catch (err) {
        console.error("Failed to load cash balance:", err);
      }
    }
    async function submitBuy() {
      const symbol = document.getElementById("buySymbol").value.trim().toUpperCase();
      const quantity = parseInt(document.getElementById("buyQuantity").value.trim());

      if (!symbol || isNaN(quantity) || quantity <= 0) {
        alert("Please enter a valid symbol and quantity.");
        return;
      }

      try {
        const res = await fetch(`${baseUrl}/portfolio/buy/${symbol}/${quantity}`, {
          method: "POST"
        });

        if (!res.ok) {
          const err = await res.json();
          alert(`❌ Error: ${err.detail}`);
          return;
        }

        alert(`✅ Successfully bought ${quantity} shares of ${symbol}`);
        loadPortfolioTable();   // refresh portfolio
        loadCashBalance();      // refresh cash balance
        document.getElementById("buySymbol").value = "";
        document.getElementById("buyQuantity").value = "";
      } catch (error) {
        console.error("Buy failed:", error);
        alert("An error occurred while buying the stock.");
      }
    }

    async function submitSell() {
      const symbol = document.getElementById("sellSymbol").value.trim().toUpperCase();
      const quantity = parseInt(document.getElementById("sellQuantity").value.trim());

      if (!symbol || isNaN(quantity) || quantity <= 0) {
        alert("Please enter a valid symbol and quantity.");
        return;
      }

      try {
        const res = await fetch(`${baseUrl}/portfolio/sell/${symbol}/${quantity}`, {
          method: "POST"
        });

        const result = await res.json();

        if (!res.ok) {
          alert(`❌ Error: ${result.detail}`);
          return;
        }

        alert(`✅ ${result.message}`);
        loadPortfolioTable();   // refresh portfolio
        loadCashBalance();      // refresh cash balance
        document.getElementById("sellSymbol").value = "";
        document.getElementById("sellQuantity").value = "";
      } catch (err) {
        console.error("Sell error:", err);
        alert("An error occurred while selling the stock.");
      }
    }


    window.onload = () => {
      loadPortfolioTable();
      loadCashBalance();
    };


  </script>

  <style>
    /* Target scrollable containers */
    .scrollable::-webkit-scrollbar {
      width: 8px;
    }

    .scrollable::-webkit-scrollbar-track {
      background: #1f2937;
      /* Tailwind gray-800 */
      border-radius: 4px;
    }

    .scrollable::-webkit-scrollbar-thumb {
      background: #4b5563;
      /* Tailwind gray-600 */
      border-radius: 4px;
    }

    .scrollable::-webkit-scrollbar-thumb:hover {
      background: #6b7280;
      /* Tailwind gray-500 */
    }
  </style>


</body>

</html>