<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Portfolio Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <a href="index.html" class="block hover:text-cyan-400"></a>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">


</head>

<body class="bg-gray-900 text-white font-sans">
    <div class="flex h-screen">
        <!-- Sidebar -->
        <aside class="w-64 bg-gray-800 p-6 flex flex-col">
            <h2 class="text-2xl font-semibold text-white mb-8 mt-2">Portfolio Manager</h2>
            <nav class="space-y-8 flex-1">
                <a href="index.html" class="flex items-center text-cyan-400 font-semibold">
                    <span class="material-icons mr-2">dashboard</span>
                    <span>Dashboard</span>
                </a>

                <a href="portfolio.html" class="flex items-center text-white hover:text-cyan-400">
                    <span class="material-icons mr-2">pie_chart</span>
                    <span>Portfolio</span>
                </a>

                <a href="news.html" class="flex items-center hover:text-cyan-400">
                    <span class="material-icons mr-2">trending_up</span>
                    <span>News</span>
                </a>

                <a href="analysis.html" class="flex items-center hover:text-cyan-400">
                    <span class="material-icons mr-2">analytics</span>
                    <span>Analysis</span>
                </a>

            </nav>
            <div class="space-y-8">
                <a href="support.html" class="flex items-center hover:text-cyan-400">
                    <span class="material-icons mr-2">help_outline</span>
                    <span>Support</span>
                </a>

                <a href="settings.html" class="flex items-center hover:text-cyan-400">
                    <span class="material-icons mr-2">settings</span>
                    <span>Settings</span>
                </a>
                <div class="flex items-center space-x-3 mt-4">
                    <img src="https://ui-avatars.com/api/?name=Kanash&background=4f46e5&color=fff&rounded=true"
                        alt="Avatar" class="w-8 h-8 rounded-full" />
                    <a href="login.html" class="text-sm text-white font-medium">Kanash</a>
                </div>
            </div>
        </aside>



        <!-- Main Content -->
        <main class="flex-1 p-6 overflow-y-auto">
            <!-- Top Bar -->
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h1 class="text-2xl font-semibold">Hello, Kanash</h1>
                    <p class="text-gray-400 text-sm">View, buy, and sell your stocks here!</p>
                </div>
                <input id="stockSearchInput" type="text" placeholder="Search stocks..."
                    class="bg-gray-700 text-white px-4 py-2 rounded" />

            </div>

            <!-- Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                <!-- Watchlist -->

                <div id="watchlist" class="space-y-2 text-white bg-gray-800 p-4 rounded">
                    <!-- Watchlist stocks will go here -->
                </div>


                <!-- Line Chart -->
                <div class="bg-gray-800 p-4 rounded shadow col-span-2">
                    <h2 class="text-lg font-semibold mb-4">Wishlist Price History</h2>
                    <canvas id="lineChart"></canvas>
                    <div class="flex justify-between mt-4 text-sm text-gray-400">
                        <span>24H</span><span>1M</span><span>3M</span><span>6M</span><span>YTD</span><span>5Y</span><span>ALL</span>
                    </div>
                </div>

                <!-- Portfolio Overview -->
                <div class="scrollable overflow-y-auto max-h-[400px] bg-gray-800 p-4 rounded shadow col-span-2">
                    <h2 class="text-lg font-semibold mb-4">Portfolio Overview</h2>
                    <table class=" w-full text-sm">
                        <thead class="text-center text-gray-400">
                            <tr>
                                <th class="p-4">Symbol</th>
                                <th class="p-4">Name</th>
                                <th class="p-4">Price</th>
                                <th class="p-4">%Change</th>
                                <th class="p-4">Qty</th>
                                <th class="p-4">Value</th>
                            </tr>
                        </thead>
                        <tbody>

                        </tbody>
                    </table>
                </div>

                <!-- Pie Chart -->
                <!-- Holdings Breakdown -->
                <div class="bg-gray-800 rounded-lg p-4">
                    <h2 class="text-white text-lg font-semibold mb-4">Holdings Breakdown</h2>

                    <!-- Fixed height container -->
                    <div class="relative h-64">
                        <canvas id="pieChart"></canvas>
                    </div>
                </div>

                <!-- News Panel -->
                <div class="bg-gray-800 p-4 rounded shadow">
                    <h2 class="text-lg font-semibold mb-4">News</h2>
                    <ul class="space-y-2 text-sm">
                        <li><strong class="text-red-400">CNN</strong> - Dow Dips As Microsoft Slips Ahead Of Earnings
                        </li>
                        <li><strong class="text-blue-400">CNBC</strong> - Nasdaq Slides As Tesla Tumbles On Delivery
                            Concerns</li>
                        <li><strong class="text-indigo-400">FOX</strong> - S&P Edges Lower As Apple Retreats Before Key
                            Report</li>
                        <li><strong class="text-white">AP</strong> - Tech Stocks Fall As Nvidia Sheds Gains</li>
                    </ul>
                </div>
            </div>
        </main>
    </div>

    <script>


        async function loadPortfolioTable() {
            try {
                const res = await fetch("http://localhost:8000/api/portfolio/displayStocks");
                const data = await res.json();
                const tableBody = document.querySelector("tbody");
                tableBody.innerHTML = "";

                let totalValue = 0;

                data.forEach(stock => {
                    const numericValue = parseFloat(stock.market_value.replace(/[^0-9.-]+/g, ""));
                    totalValue += numericValue;

                    const row = `
          <tr class="border-t border-gray-700 text-center hover:bg-gray-700 transition-colors font-light">
            <td class="p-4">${stock.symbol}</td>
            <td class="p-4">${stock.name}</td>
            <td class="p-4">${stock.last_price}</td>
            <td class="p-4 ${stock.total_gain_percent.startsWith('-') ? 'text-red-500' : 'text-green-400'}">${stock.total_gain_percent}</td>
            <td class="p-4">${stock.quantity}</td>
            <td class="p-4">${stock.market_value}</td>
          </tr>
        `;
                    tableBody.innerHTML += row;
                });
            }
            catch (err) {
                console.error("Failed to load portfolio data:", err);
            }
        }

        async function searchAndAddToWatchlist() {
            const input = document.getElementById("stockSearchInput");
            const symbol = input.value.trim().toUpperCase();

            if (!symbol) {
                alert("Please enter a stock symbol.");
                return;
            }

            try {
                // Step 1: Search for stock
                const searchRes = await fetch(`http://localhost:8000/api/search/${symbol}`);
                if (!searchRes.ok) {
                    alert("❌ Stock not found.");
                    return;
                }

                const stock = await searchRes.json();

                // Step 2: Add to watchlist
                const addRes = await fetch(`http://localhost:8000/api/watchlist/add/${symbol}`, {
                    method: "POST"
                });

                if (!addRes.ok) {
                    alert("❌ Could not add to watchlist.");
                    return;
                }

                alert(`✅ ${stock.symbol} added to your watchlist.`);
                input.value = "";

                // Optionally refresh the watchlist UI here if you're rendering it dynamically
                loadWatchlist();
                loadHoldingBreakdown(); // Refresh pie chart

            } catch (error) {
                console.error("Error:", error);
                alert("Something went wrong. Try again :)");
            }
        }

        async function loadWatchlist() {
            try {
                const res = await fetch("http://localhost:8000/api/watchlist/display");
                const stocks = await res.json();

                const container = document.getElementById("watchlist");
                container.innerHTML = "";

                if (stocks.length === 0) {
                    container.innerHTML = "<p class='text-gray-400'>Your watchlist is empty.</p>";
                    return;
                }

                stocks.forEach(stock => {
                    const item = document.createElement("div");
                    item.className = "flex justify-between items-center p-2 hover:bg-gray-600 hover:rounded transition-colors border-b border-gray-700";

                    item.innerHTML = `
                        <div onclick="loadLineChart('${stock.symbol}')" class="cursor-pointer">
                            <p class="font-semibold">${stock.symbol}</p>
                            <p class="text-sm text-[#8E70C8]">${stock.name} — $${stock.price}</p>
                        </div>
                        <button onclick="removeFromWatchlist('${stock.symbol}')" title="Remove">
                            <span class="material-icons text-red-500 hover:text-red-400">delete</span>
                        </button>
                        `;


                    container.appendChild(item);
                });
            } catch (err) {
                console.error("Failed to load watchlist:", err);
            }
        }

        let pieChartInstance = null;

        async function loadHoldingBreakdown() {
            try {
                const res = await fetch("http://localhost:8000/api/portfolio/displayStocks");
                const data = await res.json();

                const labels = [];
                const quantities = [];

                data.forEach(stock => {
                    labels.push(stock.symbol);
                    quantities.push(stock.quantity);
                });

                const ctx = document.getElementById("pieChart").getContext("2d");

                if (pieChartInstance) {
                    pieChartInstance.destroy();
                }

                pieChartInstance = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: quantities,
                            backgroundColor: [
                                '#3b82f6', '#22c55e', '#ef4444', '#eab308', '#8b5cf6', '#f97316',
                                '#06b6d4', '#84cc16', '#facc15', '#a855f7', '#10b981', '#f43f5e',
                                '#0ea5e9', '#f472b6', '#fb923c', '#14b8a6', '#e879f9', '#fde047'
                            ],
                            borderWidth: 5,
                            borderColor: '#1f2937',
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false,
                                position: 'bottom',
                                labels: {
                                    color: 'white',
                                    usePointStyle: true,
                                    pointStyle: 'circle',
                                }
                            }
                        }
                    }
                });
            } catch (err) {
                console.error("Error loading holding breakdown:", err);
            }
        }


        async function removeFromWatchlist(symbol) {
            if (!confirm(`Remove ${symbol} from watchlist?`)) return;

            try {
                const res = await fetch(`http://localhost:8000/api/watchlist/delete/${symbol}`, {
                    method: "DELETE"
                });

                if (!res.ok) {
                    alert("❌ Failed to remove from watchlist.");
                    return;
                }

                alert(`✅ Removed ${symbol} from watchlist.`);
                loadWatchlist();
                loadHoldingBreakdown(); // Refresh pie chart
            } catch (err) {
                console.error("Error removing stock:", err);
                alert("Something went wrong.");
            }
        }


        // Line Chart
        let lineChartInstance = null;

        async function loadLineChart(symbol = "AAPL") {
            try {
                const res = await fetch(`http://localhost:8000/api/search/history/${symbol}`);
                const data = await res.json();

                const ctx = document.getElementById("lineChart").getContext("2d");

                if (lineChartInstance) {
                    lineChartInstance.destroy();
                }

                lineChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.dates,
                        datasets: [{
                            label: `${data.symbol}`,
                            data: data.prices,
                            borderColor: '#8E70C8',
                            backgroundColor: 'rgba(139, 92, 246, 0.2)',
                            fill: true,
                            tension: 0.3
                        }]
                    },
                    options: {
                        plugins: {
                            legend: { labels: { color: 'white' } }
                        },
                        scales: {
                            x: { ticks: { color: 'white' }, grid: { color: '#333' } },
                            y: { ticks: { color: 'white' }, grid: { color: '#333' } }
                        }
                    }
                });
            } catch (err) {
                console.error("Failed to load line chart data:", err);
                alert("Unable to load historical data for this stock.");
            }
        }


        window.onload = () => {
            loadPortfolioTable();
            document.getElementById("stockSearchInput").addEventListener("keypress", function (e) {
                if (e.key === "Enter") searchAndAddToWatchlist();
            });
            loadWatchlist();
            loadHoldingBreakdown(); 
            loadLineChart("AAPL"); 
        };
    </script>

    <style>
        /* Target scrollable containers */
        .scrollable::-webkit-scrollbar {
            width: 8px;
        }

        .scrollable::-webkit-scrollbar-track {
            background: #1f2937;
            /* Tailwind gray-800 */
            border-radius: 4px;
        }

        .scrollable::-webkit-scrollbar-thumb {
            background: #4b5563;
            /* Tailwind gray-600 */
            border-radius: 4px;
        }

        .scrollable::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
            /* Tailwind gray-500 */
        }
    </style>
</body>

</html>